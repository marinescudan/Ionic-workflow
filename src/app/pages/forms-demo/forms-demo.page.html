<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/demo/7"></ion-back-button>
    </ion-buttons>
    <ion-title>Forms Demo</ion-title>
  </ion-toolbar>

  <ion-toolbar>
    <ion-segment [value]="selectedForm" (ionChange)="onSegmentChange($event)">
      <ion-segment-button value="registration">
        <ion-icon name="person-add"></ion-icon>
        <ion-label>Register</ion-label>
      </ion-segment-button>
      <ion-segment-button value="profile">
        <ion-icon name="create"></ion-icon>
        <ion-label>Profile</ion-label>
      </ion-segment-button>
      <ion-segment-button value="dynamic">
        <ion-icon name="settings"></ion-icon>
        <ion-label>Dynamic</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Success Message -->
  @if (submitSuccess) {
    <ion-card color="success">
      <ion-card-content>
        <div class="success-message">
          <ion-icon name="checkmark-circle"></ion-icon>
          <span>Form submitted successfully!</span>
        </div>
      </ion-card-content>
    </ion-card>
  }

  <!-- Registration Form -->
  @if (selectedForm === 'registration') {
    <ion-card>
      <ion-card-header>
        <ion-card-title>Create Account</ion-card-title>
      </ion-card-header>

      <ion-card-content>
        <form [formGroup]="registrationForm" (ngSubmit)="submitRegistration()">
          <!-- Username -->
          <ion-item [class.ion-invalid]="username.invalid && username.touched">
            <ion-input
              formControlName="username"
              label="Username"
              labelPlacement="floating"
              placeholder="Choose a username"
              autocomplete="username"
            ></ion-input>
            @if (username.pending) {
              <ion-spinner slot="end" name="dots"></ion-spinner>
            }
          </ion-item>
          <app-form-errors
            [control]="username"
            [customMessages]="{
              minlength: 'Username must be at least 3 characters',
              forbiddenValue: 'This username is reserved'
            }"
          ></app-form-errors>

          <!-- Email -->
          <ion-item [class.ion-invalid]="email.invalid && email.touched">
            <ion-input
              formControlName="email"
              type="email"
              label="Email"
              labelPlacement="floating"
              placeholder="your@email.com"
              autocomplete="email"
            ></ion-input>
            @if (email.pending) {
              <ion-spinner slot="end" name="dots"></ion-spinner>
            }
          </ion-item>
          <app-form-errors [control]="email"></app-form-errors>

          <!-- Password -->
          <ion-item [class.ion-invalid]="password.invalid && password.touched">
            <ion-input
              formControlName="password"
              [type]="showPassword ? 'text' : 'password'"
              label="Password"
              labelPlacement="floating"
              placeholder="Create a strong password"
              autocomplete="new-password"
            ></ion-input>
            <ion-button
              fill="clear"
              slot="end"
              (click)="togglePasswordVisibility('password')"
            >
              <ion-icon [name]="showPassword ? 'eye-off' : 'eye'" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>

          <!-- Password Strength Indicator -->
          <app-password-strength
            [password]="password.value || ''"
            [showRequirements]="true"
          ></app-password-strength>

          <!-- Confirm Password -->
          <ion-item [class.ion-invalid]="confirmPassword.invalid && confirmPassword.touched">
            <ion-input
              formControlName="confirmPassword"
              [type]="showConfirmPassword ? 'text' : 'password'"
              label="Confirm Password"
              labelPlacement="floating"
              placeholder="Re-enter your password"
              autocomplete="new-password"
            ></ion-input>
            <ion-button
              fill="clear"
              slot="end"
              (click)="togglePasswordVisibility('confirm')"
            >
              <ion-icon [name]="showConfirmPassword ? 'eye-off' : 'eye'" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-item>
          <app-form-errors [control]="confirmPassword"></app-form-errors>

          <!-- Password mismatch (group error) -->
          @if (registrationForm.errors?.['passwordMismatch'] && confirmPassword.touched) {
            <ion-text color="danger" class="group-error">
              <ion-icon name="alert-circle"></ion-icon>
              <span>Passwords do not match</span>
            </ion-text>
          }

          <!-- Submit Button -->
          <ion-button
            type="submit"
            expand="block"
            [disabled]="registrationForm.invalid || registrationForm.pending || isSubmitting"
            class="submit-button"
          >
            @if (isSubmitting) {
              <ion-spinner name="crescent"></ion-spinner>
            } @else if (registrationForm.pending) {
              Validating...
            } @else {
              Create Account
            }
          </ion-button>

          <!-- Form Debug Info (remove in production) -->
          <div class="debug-info">
            <p>Form Status: {{ registrationForm.status }}</p>
            <p>Valid: {{ registrationForm.valid }}</p>
            <p>Pending: {{ registrationForm.pending }}</p>
          </div>
        </form>
      </ion-card-content>
    </ion-card>
  }

  <!-- Profile Form -->
  @if (selectedForm === 'profile') {
    <form [formGroup]="profileForm" (ngSubmit)="submitProfile()">
      <!-- Personal Info Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Personal Information</ion-card-title>
        </ion-card-header>
        <ion-card-content formGroupName="personalInfo">
          <ion-item>
            <ion-input
              formControlName="firstName"
              label="First Name"
              labelPlacement="floating"
            ></ion-input>
          </ion-item>
          <app-form-errors [control]="personalInfo.get('firstName')"></app-form-errors>

          <ion-item>
            <ion-input
              formControlName="lastName"
              label="Last Name"
              labelPlacement="floating"
            ></ion-input>
          </ion-item>
          <app-form-errors [control]="personalInfo.get('lastName')"></app-form-errors>

          <ion-item>
            <ion-input
              formControlName="email"
              type="email"
              label="Email"
              labelPlacement="floating"
            ></ion-input>
          </ion-item>
          <app-form-errors [control]="personalInfo.get('email')"></app-form-errors>

          <ion-item>
            <ion-input
              formControlName="phone"
              type="tel"
              label="Phone"
              labelPlacement="floating"
              placeholder="+1234567890"
            ></ion-input>
          </ion-item>
          <app-form-errors
            [control]="personalInfo.get('phone')"
            [customMessages]="{ pattern: 'Enter valid phone (e.g., +1234567890)' }"
          ></app-form-errors>
        </ion-card-content>
      </ion-card>

      <!-- Address Section -->
      <ion-card>
        <ion-card-header>
          <ion-card-title>Address</ion-card-title>
        </ion-card-header>
        <ion-card-content formGroupName="address">
          <ion-item>
            <ion-input
              formControlName="street"
              label="Street"
              labelPlacement="floating"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              formControlName="city"
              label="City"
              labelPlacement="floating"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              formControlName="state"
              label="State"
              labelPlacement="floating"
            ></ion-input>
          </ion-item>

          <ion-item>
            <ion-input
              formControlName="zipCode"
              label="ZIP Code"
              labelPlacement="floating"
              placeholder="12345"
            ></ion-input>
          </ion-item>
          <app-form-errors
            [control]="address.get('zipCode')"
            [customMessages]="{ pattern: 'Enter valid ZIP (12345 or 12345-6789)' }"
          ></app-form-errors>
        </ion-card-content>
      </ion-card>

      <ion-button
        type="submit"
        expand="block"
        [disabled]="profileForm.invalid || isSubmitting"
      >
        @if (isSubmitting) {
          <ion-spinner name="crescent"></ion-spinner>
        } @else {
          Save Profile
        }
      </ion-button>
    </form>
  }

  <!-- Dynamic Form -->
  @if (selectedForm === 'dynamic') {
    <ion-card>
      <ion-card-header>
        <ion-card-title>Dynamic Form</ion-card-title>
        <ion-note>Form built from configuration</ion-note>
      </ion-card-header>
      <ion-card-content>
        <p>See the Dynamic Form section in the chapter for implementation details.</p>
      </ion-card-content>
    </ion-card>
  }
</ion-content>
